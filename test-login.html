<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信登录测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0a0a0f;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .test-container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 1rem;
        }
        button {
            background: #00ff88;
            color: #0a0a0f;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: bold;
            margin: 0.5rem;
        }
        button:hover {
            background: #00cc6a;
        }
        #qrcode {
            margin: 1rem 0;
            min-height: 200px;
            border: 1px solid #333;
            border-radius: 0.5rem;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>微信登录测试</h1>
        <button onclick="testWechatLogin()">测试微信登录</button>
        <div id="qrcode"></div>
        <div id="result"></div>
    </div>

    <script>
        // 微信配置
        const WECHAT_APPID = 'wx2e1f9ccab9e27176';
        const WECHAT_SECRET = '2b0086643a47fe0de574efbfc27c0718';

        // 生成随机状态码
        function generateRandomState() {
            return Math.random().toString(36).substring(2, 15) + 
                   Math.random().toString(36).substring(2, 15) + 
                   Date.now().toString(36);
        }

        // 测试微信登录
        function testWechatLogin() {
            const qrcode = document.getElementById('qrcode');
            const result = document.getElementById('result');
            
            try {
                // 生成授权URL
                const state = generateRandomState();
                localStorage.setItem('wechat_auth_state', state);
                
                // 使用配置的授权回调域名（需要在微信公众平台后台配置）
                const redirectUri = encodeURIComponent('https://aimorelogy.github.io/wechat-callback.html');
                const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${WECHAT_APPID}&redirect_uri=${redirectUri}&response_type=code&scope=snsapi_userinfo&state=${state}#wechat_redirect`;
                
                // 生成二维码
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(authUrl)}`;
                
                qrcode.innerHTML = `
                    <h3>扫描二维码登录</h3>
                    <img src="${qrApiUrl}" alt="微信登录二维码" style="width: 200px; height: 200px; border-radius: 0.5rem;">
                    <p>请使用微信扫描二维码</p>
                    <button onclick="openAuthWindow('${authUrl}')">直接授权</button>
                `;
                
                result.innerHTML = '<p style="color: #00ff88;">二维码生成成功！</p>';
                
                // 开始轮询检查登录状态
                startPolling();
                
            } catch (error) {
                result.innerHTML = `<p style="color: #ff3366;">错误: ${error.message}</p>`;
                console.error('微信登录测试失败:', error);
            }
        }

        // 打开授权窗口
        function openAuthWindow(authUrl) {
            const authWindow = window.open(authUrl, 'wechat_auth', 'width=400,height=600,scrollbars=yes,resizable=yes');
            
            // 监听窗口关闭
            const checkClosed = setInterval(() => {
                if (authWindow.closed) {
                    clearInterval(checkClosed);
                    setTimeout(() => {
                        checkAuthResult();
                    }, 1000);
                }
            }, 1000);
        }

        // 开始轮询
        function startPolling() {
            const pollInterval = setInterval(() => {
                checkAuthResult();
            }, 2000);
            
            // 5分钟后停止
            setTimeout(() => {
                clearInterval(pollInterval);
            }, 300000);
        }

        // 检查授权结果
        function checkAuthResult() {
            const authResult = localStorage.getItem('wechat_auth_result');
            const result = document.getElementById('result');
            
            if (authResult) {
                try {
                    const data = JSON.parse(authResult);
                    if (data.success) {
                        result.innerHTML = `
                            <div style="color: #00ff88;">
                                <h3>登录成功！</h3>
                                <p>用户: ${data.userInfo.nickname}</p>
                                <p>等级: ${data.userInfo.level}</p>
                                <p>OpenID: ${data.userInfo.openid}</p>
                            </div>
                        `;
                    } else {
                        result.innerHTML = `<p style="color: #ff6b35;">登录失败: ${data.message}</p>`;
                    }
                    localStorage.removeItem('wechat_auth_result');
                } catch (error) {
                    result.innerHTML = `<p style="color: #ff3366;">解析结果失败: ${error.message}</p>`;
                }
            }
        }

        // 监听来自回调页面的消息
        window.addEventListener('message', (event) => {
            if (event.data.type === 'wechat_login_success') {
                const result = document.getElementById('result');
                result.innerHTML = `
                    <div style="color: #00ff88;">
                        <h3>登录成功！</h3>
                        <p>用户: ${event.data.userInfo.nickname}</p>
                        <p>等级: ${event.data.userInfo.level}</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>