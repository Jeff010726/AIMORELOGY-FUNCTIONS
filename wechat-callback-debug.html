<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信登录处理中...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .loading-container {
            text-align: center;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
        }
        
        .loading-icon {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 255, 136, 0.3);
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #00ff88;
        }
        
        p {
            color: #b8bcc8;
            margin-bottom: 1rem;
        }
        
        .error {
            color: #ff3366;
        }
        
        .debug-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .debug-title {
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="loading-container">
        <div class="loading-icon"></div>
        <h1>微信登录处理中...</h1>
        <p id="status">正在验证授权信息，请稍候...</p>
        <div id="debugInfo" class="debug-info" style="display: none;">
            <div class="debug-title">调试信息：</div>
            <div id="debugContent"></div>
        </div>
    </div>

    <script>
        // 微信配置
        const WECHAT_APPID = 'wx2e1f9ccab9e27176';
        
        // 配置的授权回调域名
        const CALLBACK_DOMAIN = 'https://jeff010726.github.io/AIMORELOGY-FUNCTIONS';
        
        // Cloudflare Workers URL
        const WORKER_URL = 'https://ecommerce-api.jeff010726bd.workers.dev';
        
        // 调试日志函数
        function debugLog(message, data = null) {
            console.log(message, data);
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            debugInfo.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}${data ? '\n' + JSON.stringify(data, null, 2) : ''}\n\n`;
            debugContent.textContent += logEntry;
        }
        
        // 微信授权登录模块 - 简化版
        class WechatAuthDebug {
            constructor(workerUrl) {
                this.workerUrl = workerUrl;
            }

            // 验证状态码
            validateState(state) {
                const savedState = localStorage.getItem('wechat_auth_state');
                debugLog('状态验证', { received: state, saved: savedState });
                
                if (state === savedState) {
                    localStorage.removeItem('wechat_auth_state');
                    return true;
                }
                return false;
            }

            // 完整的登录流程 - 通过Cloudflare Workers
            async handleAuthCallback(code, state) {
                try {
                    debugLog('开始处理授权回调', { code, state });
                    
                    // 1. 验证state
                    if (!this.validateState(state)) {
                        throw new Error('状态验证失败，可能存在安全风险');
                    }
                    debugLog('状态验证通过');

                    // 2. 通过Cloudflare Workers处理授权
                    debugLog('调用Workers API', { url: `${this.workerUrl}/wechat/auth` });
                    
                    const response = await fetch(`${this.workerUrl}/wechat/auth`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ code, state })
                    });

                    debugLog('Workers API响应', { 
                        status: response.status, 
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries())
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    debugLog('Workers API返回数据', data);
                    
                    return data;

                } catch (error) {
                    debugLog('处理授权回调失败', { 
                        error: error.message, 
                        stack: error.stack 
                    });
                    throw error;
                }
            }
        }

        // 创建微信授权实例
        const wechatAuth = new WechatAuthDebug(WORKER_URL);
        
        // 处理微信授权回调
        async function handleWechatCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            const statusEl = document.getElementById('status');
            
            debugLog('页面加载完成，开始处理回调', {
                url: window.location.href,
                code: code ? code.substring(0, 10) + '...' : null,
                state: state ? state.substring(0, 10) + '...' : null,
                error
            });
            
            if (error) {
                statusEl.textContent = `授权失败: ${error}`;
                statusEl.className = 'error';
                debugLog('微信授权失败', { error });
                setTimeout(() => {
                    window.close();
                }, 5000);
                return;
            }
            
            if (!code || !state) {
                statusEl.textContent = '授权参数缺失，请重试';
                statusEl.className = 'error';
                debugLog('授权参数缺失', { code: !!code, state: !!state });
                setTimeout(() => {
                    window.close();
                }, 5000);
                return;
            }
            
            try {
                statusEl.textContent = '正在验证登录信息...';
                debugLog('开始验证登录信息');
                
                // 使用微信授权模块处理登录
                const result = await wechatAuth.handleAuthCallback(code, state);
                
                if (result.success) {
                    // 登录成功
                    statusEl.textContent = '登录成功！正在跳转...';
                    debugLog('登录成功', result.userInfo);
                    
                    // 保存用户信息
                    const userInfo = {
                        ...result.userInfo,
                        level: determineUserLevel(result.userInfo),
                        usageCount: 0,
                        maxUsage: getMaxUsageByLevel(determineUserLevel(result.userInfo)),
                        loginTime: Date.now()
                    };
                    
                    // 保存到localStorage
                    localStorage.setItem('wechat_auth_result', JSON.stringify({
                        success: true,
                        userInfo: userInfo
                    }));
                    
                    // 通知父窗口
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'wechat_login_success',
                            userInfo: userInfo
                        }, '*');
                    }
                    
                    setTimeout(() => {
                        if (window.opener) {
                            window.close();
                        } else {
                            window.location.href = 'index.html';
                        }
                    }, 2000);
                    
                } else if (result.needSubscribe) {
                    // 需要关注公众号
                    statusEl.textContent = result.message;
                    debugLog('需要关注公众号', result);
                    showSubscribePrompt();
                    
                } else {
                    // 其他错误
                    statusEl.textContent = result.message;
                    statusEl.className = 'error';
                    debugLog('登录失败', result);
                    setTimeout(() => {
                        window.close();
                    }, 5000);
                }
                
            } catch (error) {
                console.error('处理微信登录失败:', error);
                statusEl.textContent = `登录处理失败: ${error.message}`;
                statusEl.className = 'error';
                debugLog('异常捕获', { 
                    message: error.message, 
                    stack: error.stack 
                });
                
                // 不自动关闭窗口，让用户看到调试信息
                setTimeout(() => {
                    if (confirm('查看调试信息后，点击确定关闭窗口')) {
                        window.close();
                    }
                }, 3000);
            }
        }
        
        // 确定用户等级
        function determineUserLevel(userInfo) {
            if (userInfo.subscribe_time) {
                const subscribeDate = new Date(userInfo.subscribe_time * 1000);
                const now = new Date();
                const daysSinceSubscribe = (now - subscribeDate) / (1000 * 60 * 60 * 24);
                
                if (daysSinceSubscribe > 365) {
                    return 'SVIP';
                } else if (daysSinceSubscribe > 30) {
                    return 'VIP';
                }
            }
            return '普通用户';
        }
        
        // 根据等级获取最大使用次数
        function getMaxUsageByLevel(level) {
            const limits = {
                '普通用户': 10,
                'VIP': 50,
                'SVIP': 200,
                'Admin': 999999
            };
            return limits[level] || 10;
        }
        
        // 显示关注提示
        function showSubscribePrompt() {
            const container = document.querySelector('.loading-container');
            container.innerHTML = `
                <div style="text-align: center;">
                    <h1 style="color: #ff6b35;">需要关注服务号</h1>
                    <p>请先关注我们的微信服务号，然后重新扫码登录</p>
                    <div style="margin: 2rem 0;">
                        <img src="qrcode_for_gh_ede2796af721_258.jpg" alt="微信服务号二维码" 
                             style="width: 200px; height: 200px; border-radius: 8px; border: 2px solid #00ff88;">
                    </div>
                    <p style="color: #b8bcc8; font-size: 0.9rem;">扫码关注后请重新登录</p>
                    <button onclick="window.close()" 
                            style="margin-top: 1rem; padding: 0.5rem 1rem; background: #00ff88; color: #0a0a0f; border: none; border-radius: 4px; cursor: pointer;">
                        关闭窗口
                    </button>
                </div>
            `;
        }
        
        // 页面加载时处理回调
        document.addEventListener('DOMContentLoaded', handleWechatCallback);
    </script>
</body>
</html>